---
title: "jstable을 이용한 분석 모형 table 만들기"
description: |
  GLM, GLE, GLMM, COX 모델에 대해 알아보고, 이를 직관적으로 표시할 수 있는 table을 만들어봅니다.
  
image: img/main2.jpg
categories:
  - R
  - statistics
author:
  - name: Hyungwoo Jo
    url: https://github.com/sl-eeper
fig_width: 400
date: 2024-09-13
format: html
execute:
  freeze: true
draft: false
license: CC BY-NC
editor: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
library(jstable)
library(survival)
library(coxme)
library(dplyr)
library(survey)
library(testthat)
```

# 개요

이 문서에서는 GLM, GEE, GLMM, Cox 모델에 대한 개요와 이를 jstable
패키지와 더불어 활용하는 방법을 소개합니다.

# 1. GLM

## GLM의 개요

GLM은 Generalized Linear Model의 약자로 일반화 선형 모델을 의미합니다.
이는 선형 회귀 모델을 조금더 일반화한 모형으로, 반응변수가 정규분포를 따르지 않는 경우에도 사용하기 위해 만들어진
모델입니다. 정규 분포가 아닌 흔한 예시로는 이항분포, 포아송 분포 등이
있습니다. 나이에 따른 생존 상태(생존은 1, 사망은 0)인 이항분포 반응변수를 예시로 일반적 선형회귀 모델과 GLM을 통해 로지스틱 회귀 분석을 한 결과를 비교해보겠습니다. 

```{r}
library(ggplot2)
library(dplyr)
set.seed(123)
n <- 100
age <- rnorm(n, mean = 50, sd = 10)  
logit_prob <- 1 / (1 + exp(-(0.2 * (age - 50))))  
dead <- rbinom(n, size = 1, prob = logit_prob) 
data <- data.frame(age = age, dead = dead)
logit_model <- glm(dead ~ age, family = binomial, data = data)
linear_model <- lm(dead ~ age, data = data)
age_seq <- seq(min(data$age), max(data$age), length.out = 100)
logit_pred <- predict(logit_model, newdata = data.frame(age = age_seq), type = "response")
linear_pred <- predict(linear_model, newdata = data.frame(age = age_seq))

ggplot(data, aes(x = age, y = dead)) +
  geom_point(aes(color = as.factor(dead)), size = 2.5, alpha = 0.7) +  
  geom_line(aes(x = age_seq, y = logit_pred), color = "blue", linewidth = 1.2) +  
  geom_line(aes(x = age_seq, y = linear_pred), color = "red", linewidth = 1.2, linetype = "dashed") +  
  labs(title = "Logistic vs. Linear Regression on Binomial Data (1 = Death, 0 = Alive)",
       x = "Age", y = "Probability of Death",
       color = "Death (1 = Death, 0 = Alive)") +
  scale_color_manual(values = c("purple", "green")) +  
  theme_minimal()
```
 일반적인 선형 회귀 함수를 적용했을 때 나이가 어린 경우에는 사망 확률이 음수가 나오며, 고령인 경우 사망 확률이 1이 넘는 등의 문제가 발생합니다. 이를 해결하기 위해 GLM(로지스틱 회귀모형)을 적용하면 모든 나이에서 사망 확률이 0에서 1사이가 됨을 알 수 있습니다. 

## GLM을 적용하기 위한 데이터의 조건
 이항 분포에 대해 GLM을 적용하였지만, 모든 데이터에 GLM을 적용할 수 있는 것은 아닙니다. GLM을 적용하기 위한 조건에 대해 알아보겠습니다.

### 반응변수의 분포
 반응 변수의 분포 형태가 Exponential family(지수 분포군)를 따를 때 GLM을 적용할 수 있다. Exponential family는 아래와 같은 수식으로 나타낼 수 있다. 
$$
f(y | \theta, \phi) = \exp\left( \frac{y\theta - b(\theta)}{\phi} + c(y, \phi) \right)
$$
 여기서$y$는 반응 변수 \( \theta \)는 정규화 매게 변수,   \( \phi \)는 분산을 나타냅니다. 이항분포의 경우 성공 확률 \( p \)로 정의되며 아래 함수의 경우 위의 지수 분포군 함수로 변환이 가능합니다. 위와 같이 변형이 가능한 분포의 다른른 예시로는는 포아송 분포, 감마 분포 등이 있습니다.
$$
P(Y = y) = \binom{n}{y} p^y (1 - p)^{n - y}
$$

### 링크 함수
 링크 함수는 반응 변수의 평균과 예측 변수의 선형 관계를 나타내는 함수입니다. 반응변수의 분포가 지수 분포군에 있을 때 링크함수가 존재하며 포아송 분포의 경우 예시는 이와 같습니다. 아래 함수를 적용하면 선형 관계의 그래프를 얻을 수 있습니다.
$$
\log\left( \frac{1 - \mu}{\mu} \right) = X\beta
$$

### 관측치 독립
 관측치들이 독립되어야 적용이 가능합니다. 예를 들어, 한 사람의 혈압을 반복측정하는 경우 관측치들이 독립되어 있지 않기 때문에 다른 모델을 사용하여야 합니다. 이 경우에 대해서는 문서의 아래 GEE, GLMM 서술에서 다루겠습니다.

## jstable 패키지를 사용한 GLM table만들기
 jstable 패키지를 사용하여 이항 분포와 가우스 분포의 GLM 모델의 결과를 직관적인 표로 만들 수 있습니다. 아래 코드는 mtcars 데이터를 사용하여과 이항 회귀 모델을 만들고 결과를 표로 나타낸 것입니다. R에서 제공되는 mtcars 데이터를 통해 이항분포를 가지는 am(자동미션 =0, 수동미션 =1)을 wt(차량무게), hp(마력)을 통해 예측하는 GLM에 대해 알아보겠습니다. 
```{r}
binomial_model <- glm(am ~ wt + hp, family = binomial, data = mtcars)
summary(binomial_model)
```
 R에서 기본적으로 제공하는 summary 함수를 통해서 모델에 대해서 알아보았습니다. 많은 정보가 이 안에 담겨있으나, 다소 직관적이지 않을 수 있습니다. jstable 패키지를 사용하여 이를 표로 나타낼 수 있습니다. 
```{r}
binomial_model <- glm(am ~ wt + hp, family = binomial, data = mtcars)
glmshow.display(binomial_model, decimal = 2)
```
 이항 분포의 glm에 대하여 첫줄에서는 로지스틱 회귀 분석을 사용했음을 알 수 있습니다. 
테이블 출력 결과를 통해 wt 변수는 p-value가 0.0001로 유의미하게 am에 영향을 미치는 것을 알 수 있습니다. Crude OR 변수를 통해 wt변수가 1이 증가할때마다 수동미션을 가질 odds 비율이 98프로 씩 감소한다는 것을 알 수 있습니다. Adjusted OR 변수가 0이라는 것을 통해 hp변수를 보정했을 경우에 Odds 비율이 더 강하게 연관되어 있다는 것을 알 수 있으며, adjusted p value또한 유의미하다는 것을 확인 할 수 있습니다. hp의 경우 OR과 p value를 통해 관련이 적음을 유추할 수 있습니다. 마지막 줄에서는 총 몇 개의 관측치가 있었는지, 그리고 AIC 수치를 통해 낮을 수록 더 좋은 모델이라는 것을 시사합니다.
```{r}
gaussian_model <- glm(mpg~cyl + disp, data = mtcars)
glmshow.display(gaussian_model, decimal = 2)
```
 이항 분포와 마찬가지로 첫줄에서는 정규분포에 대하여 선형 회귀 분석을 사용했음을 알 수 있고, 해당하는 p value 들 그리고 선형 회귀의 경우 Coeffecient를 제공함을 알 수 있습니다. 해당 테이블을 통해 cyl(실린더의 갯수)변수는 mpg(연비)에 유의미한 영향을 미치는 것을 알 수 있습니다. disp(배기량)변수는 보정 전에는 영향이 있어 보였으나 보정 이후 0.05보다 크기 때문에 통계적으로 유의미한 영향을 미치지 않는 것을 알 수 있습니다. 

# 2. GEE
GEE(Generalized Estimating Equations)는 GLM에서 반복 측정 혹은 군집화 데이터와 같이 상관된 데이터를 처리하기 위해 만들어진 확장된 모델입니다. GLM의 경우 링크 함수를 통한 선형 회귀 분석을 하기 때문에 기본적으로 관측치들 간의 상관관계가 없어야 한다는 선형 회귀분석의 기본 가정을 따르게 됩니다. 하지만 실제 데이터의 경우(반복된 혈압의 측정, 병원 내 환자들)과 같은 반복, 군집 데이터들을 통해 반응 변수를 분석해야 하는 경우가 많습니다.
당뇨병 환자의 당뇨약 복용 이후 혈당변화를 예시로 생각해보겠습니다. 이를 일반적인 GLM 모형인 \[g(\mu_{i}) = X_{i} \beta\]에 적용을 한다면(g가 링크 함수, X가 종속 변수) 같은 환자에서 반복된 혈당 측정치들이 모두 독립이란 가정이 필요합니다. 따라서 같은 환자의 경우 혈당 측정치들은 관련성이 있기 때문에 상관관계를 반영하여   \[g(\mu_{ij}) = X_{ij} \beta\] 와 같은 형태의 수식을 사용할 수 있습니다.(이경우 X_{ij}는 i번째 환자의 j번째 관측치입니다)