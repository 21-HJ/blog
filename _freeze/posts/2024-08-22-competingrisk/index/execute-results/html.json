{
  "hash": "df68228f9a07176fb12f707b33d1f5b3",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"다변수 생존 분석, competing risk와 multi-step model \"\ndescription: |\n  생존분석에서 다양한 event를 정의할 수 있는 방법인 competing risk(fine and gray)와 multi-step model(msm)에 대해 소개합니다.\n  \nimage: main.png\ncategories:\n  - R\n  - statistics\nauthor:\n  - name: Hyojong Myung\n    url: https://github.com/MyungHyojong\nfig_width: 400\ndate: 2023-08-22\nformat: html\nexecute:\n  freeze: true\ndraft: false\nlicense: CC BY-NC\n---\n\n\n\n\n\nKaplan-Meirer 또는 Cox 생존 분석은 하나의 event가 발생한 시점을 기반해 생성된 생존시간에 데이터를 기반으로 이뤄집니다. 하지만 추적 관찰 도중 일어나는 event를 하나의 변수로 표현하는 것은 적절치 않을 수 있습니다. 다양한 변수를 생존분석에 고려하고자 사용되는 대표적인 모델이 competing risk와 multistep 모델입니다.\n\n# 1. competing risk\n\nCompeting risk 모델은 하나의 사건(event)이 발생하는 것을 다른 경쟁 위험들(competing risks)이 방해하는 상황을 가정합니다. 예를 들어, 환자가 A라는 질병으로 인해 사망할 수도 있지만, 다른 이유로도 사망할 수도 있습니다. 이 경우, 질병 A으로 인한 사망이 관찰하고자 하는 사건이고, 다른 이유로 인한 사망은 경쟁 위험이 됩니다. Fine-Gray method는 환자의 다른 질병으로 인한 사망(다른 risk로 endpoint에 도달한 경우)한 케이스를, '만약 다른 질병에 걸리지 않았다면?' 이라는 가정을 기반으로 가공해 새로운 데이터를 만들어냅니다. 가정을 통해 만들어진 데이터인 만큼 해당 데이터가 존재할만한 확률을 계산해 이를 가중치로서 사용합니다. 데이터와 함께 과정을 살펴보도록 하겠습니다.\n\n## 1.1 데이터 전처리\n\n실습에서는 `mgus2` 데이터를 사용하겠습니다. `mgus` 데이터는 다발성 골수종 환자에 대한 데이터로, `pstat`이 1인 경우 다발성 골수종에 걸린 것으로 표시됩니다.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata <- mgus2\nhead(data)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  id age sex dxyr  hgb creat mspike ptime pstat futime death\n1  1  88   F 1981 13.1   1.3    0.5    30     0     30     1\n2  2  78   F 1968 11.5   1.2    2.0    25     0     25     1\n3  3  94   M 1980 10.5   1.5    2.6    46     0     46     1\n4  4  68   M 1977 15.2   1.2    1.2    92     0     92     1\n5  5  90   F 1973 10.7   0.8    1.0     8     0      8     1\n6  6  90   M 1990 12.9   1.0    0.5     4     0      4     1\n```\n\n\n:::\n:::\n\n\n\n이후 `data`의 `even`t를 다발성 골수종에 걸렸을 경우(`pcm`) 1, 다발성 골수종에 걸리지 않았지만 사망한 경우(`death`) 2, 다발성 골수종에 걸리지도 않았고 생존한 경우(`censor`) 0으로 코딩합니다. competing risk가 고려하고자 하는 데이터는 다벌성 골수종이 아닌 다른 이유로 사망한 2번 케이스 일것입니다.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata$etime <- with(data, ifelse(pstat==0, futime, ptime))\ndata$event <- with(data, ifelse(pstat==0, 2*death, 1))\ndata$event <- factor(data$event, 0:2, labels=c(\"censor\", \"pcm\", \"death\"))\n```\n:::\n\n\n\n## 1.2 competing risk 제거\n\n`finegray` 함수를 사용하면 해당 데이터가 `death`로 끝났을 경우, 환자가 사망하지 않았다고 가정한 새로운 데이터들을 여러 시간대 별로 제작합니다. 각 시간대별로 환자가 생존했을 확률을 hazard ratio를 계산함으로서 이를 weight로 사용합니다.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npdata <- finegray(Surv(etime, event) ~ ., data=data)\nhead(pdata)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  id age sex dxyr  hgb creat mspike ptime pstat futime death fgstart fgstop\n1  1  88   F 1981 13.1   1.3    0.5    30     0     30     1       0     35\n2  1  88   F 1981 13.1   1.3    0.5    30     0     30     1      35     44\n3  1  88   F 1981 13.1   1.3    0.5    30     0     30     1      44     47\n4  1  88   F 1981 13.1   1.3    0.5    30     0     30     1      48     52\n5  1  88   F 1981 13.1   1.3    0.5    30     0     30     1      53     56\n6  1  88   F 1981 13.1   1.3    0.5    30     0     30     1      56     57\n  fgstatus      fgwt\n1        0 1.0000000\n2        0 0.9990449\n3        0 0.9980368\n4        0 0.9959629\n5        0 0.9905896\n6        0 0.9873022\n```\n\n\n:::\n:::\n\n\n\n`pdata`에서 볼 수 있다 싶이 `id` 1번 환자는 실제로 30일 follow up 이후 사망했지만, pdata에서는 환자가 30일 이후 생존했을 경우를 가정하고, `fgwt`로 인위적인 데이터의 weight를 보여주고 있습니다. 실제로 시간이 길어질 수록 환자가 생존할 가능성은 떨어지기에 weight 역시 감소하는 것을 볼 수 있습니다. `pdata`의 event로 사용되는 `fgstatus`는 다발성 골수종의 발생에만 집중하여 다발성 골수종 발생 경우 1,(`data`의 `pcm`과 동일) 미발생시 0(`censor`와 동일)으로 표시하고 있습니다.\n\n이제 competing risk로 인한 데이터를 제거했기 때문에 기존의 cox 분석으로 결과를 얻을 수 있습니다.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfgfit <- coxph(Surv(fgstart, fgstop, fgstatus) ~ age+sex,\n               weight=fgwt, data=pdata, model = T)\nsummary(fgfit)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCall:\ncoxph(formula = Surv(fgstart, fgstop, fgstatus) ~ age + sex, \n    data = pdata, weights = fgwt, model = T)\n\n  n= 41775, number of events= 115 \n\n          coef exp(coef)  se(coef) robust se     z Pr(>|z|)   \nage  -0.017302  0.982847  0.007022  0.005528 -3.13  0.00175 **\nsexM -0.259757  0.771239  0.187049  0.181707 -1.43  0.15285   \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n     exp(coef) exp(-coef) lower .95 upper .95\nage     0.9828      1.017    0.9723    0.9936\nsexM    0.7712      1.297    0.5402    1.1012\n\nConcordance= 0.548  (se = 0.026 )\nLikelihood ratio test= 7.28  on 2 df,   p=0.03\nWald test            = 11.19  on 2 df,   p=0.004\nScore (logrank) test = 7.58  on 2 df,   p=0.02,   Robust = 9.28  p=0.01\n\n  (Note: the likelihood ratio and score tests assume independence of\n     observations within a cluster, the Wald and robust score tests do not).\n```\n\n\n:::\n:::\n\n\n\n# 2. multistep model\n\n멀티스텝 모델 (Multi-State Model, MSM)은 시간에 따라 환자가 여러 상태 사이를 전이하는 과정을 가정합니다. 예를 들어, 환자가 \"건강한 상태\"에서 \"질병 상태\"로, 그리고 \"사망 상태\"로 변화하는 것을 수치화해 생존 분석을 진행합니다.\n\n<img src=\"img/main.png\" width=\"100%\"/>\n\n환자의 상태를 계층화된 factor로 지정해준 후, Aalen-Johansen Estimator을 이용해 각 시간 지점에서 특정 상태에 있을 확률을 계산합니다(<https://www.openriskmanual.org/wiki/Aalen-Johansen_Estimator>). 데이터를 기반으로 각 고유한 시간에 전이하는 환자의 비율을 나타내는 전이행렬을 초기 확률 벡터와 곱함으로서 특정 시간에 각 상태에 있는 확률을 계산할 수 있습니다.\n\n## 2.1 데이터 전처리\n\n이번 실습에서도 `mgus2` 데이터를 사용합니다. 다만 해당 msm 모델에서는 `data`의 event 간 step이 존재해야 하기 때문에 다발성 골수종에 걸리지 않은 환자(`censor`)를 0, 다발성 골수종에 걸렸지만 생존한 환자를 (`pcm`) 1, 다발성 골수종에 걸린 후 사망한 환자를(`death by pcm`) 1로 지정했습니다.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata <- mgus2\ndata$etime <- with(data, ifelse(pstat == 0, futime, ptime))\nevent <- with(data, ifelse(pstat == 0, 0, ifelse(death== 1, 2, 1)))\ndata$event <- factor(event, 0:2, labels = c(\"censor\", \"pcm\", \"death by pcm\"))\n```\n:::\n\n\n\n## 2.2 msm 모델 제작\n\n이후 `data`를 기존에 0과 1로 outcome이 이진 분류된 데이터로 cox 모델을 돌리듯 모델을 제작해주면 각 상태(`pcm`, `death by pcm`)로의 진행에 대한 회귀분석이 진행됩니다.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmsmfit <- coxph(Surv(etime, event) ~ sex+ age, data = data, id = id, model = T)\nsummary(msmfit)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCall:\ncoxph(formula = Surv(etime, event) ~ sex + age, data = data, \n    model = T, id = id)\n\n  n= 1384, number of events= 115 \n\n              coef exp(coef)  se(coef) robust se      z Pr(>|z|)   \nsexM_1:2 -0.039525  0.961246  0.585241  0.558411 -0.071  0.94357   \nage_1:2  -0.033851  0.966715  0.022021  0.019780 -1.711  0.08701 . \nsexM_1:3 -0.016455  0.983679  0.199274  0.201272 -0.082  0.93484   \nage_1:3   0.019480  1.019671  0.008933  0.006959  2.799  0.00512 **\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n         exp(coef) exp(-coef) lower .95 upper .95\nsexM_1:2    0.9612     1.0403    0.3217     2.872\nage_1:2     0.9667     1.0344    0.9300     1.005\nsexM_1:3    0.9837     1.0166    0.6630     1.459\nage_1:3     1.0197     0.9807    1.0059     1.034\n\nConcordance= 0.563  (se = 0.026 )\nLikelihood ratio test= 7.34  on 4 df,   p=0.1\nWald test            = 11.39  on 4 df,   p=0.02\nScore (logrank) test = 7.28  on 4 df,   p=0.1,   Robust = 10.39  p=0.03\n\n  (Note: the likelihood ratio and score tests assume independence of\n     observations within a cluster, the Wald and robust score tests do not).\n```\n\n\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}