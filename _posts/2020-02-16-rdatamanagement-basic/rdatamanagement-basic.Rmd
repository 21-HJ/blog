---
title: "R 데이터 매니지먼트: 기초"
description: |
  R 기초연산을 다룬 후, 보험공단 샘플 데이터를 이용하여 데이터 다루는 법을 정리하였습니다. 본 내용은 서울대병원 진단검사의학과 선생님들의 교육에 쓰일 예정입니다. 
preview: https://lh3.googleusercontent.com/proxy/2ak4xAEz9T-3Kc8DrmPWfclqROWB3IDLgQUmY_j1OJ-d5pFBzPU_Qhn8ijvhXyWCF02Q_l08wpRChHVQ4yBDdDTFzjt-s8ia
categories:
  - presentation
  - lecture
  - r
author:
  - name: Jinseob Kim
    url: https://github.com/jinseob2kim
    affiliation: Zarathu Co.,Ltd
    affiliation_url: https://www.zarathu.com
date: 02-14-2020
output:
  distill::distill_article:
    self_contained: false
    toc: true
    toc_depth: 2
draft: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=T, fig.align = "center")
library(rmarkdown);library(knitr)
```

[김진섭](https://github.com/jinseob2kim) 대표는 3월 18일(수) 부터 6회에 걸쳐, **[서울대병원 진단검사의학과](http://www.snuhlab.org/main/main.aspx) 의국원들의 통계분석 능력 함양을 위한 맞춤 교육** 이라는 주제로 R 교육을 진행할 예정입니다. 강의록을 미리 공유합니다.



## 시작하기 전에 

**[R](https://www.r-project.org/)** 데이터 매니지먼트 방법은 크게 3 종류가 있다.  

1. 원래의 **[R](https://www.r-project.org/)** 문법을 이용한 방법으로  **[과거 홈페이지](https://jinseob2kim.github.io/rbasic.html)**^[https://jinseob2kim.github.io/rbasic.html]에 정리했었다.  
  

2. **[tidyverse](https://www.tidyverse.org/)**는 직관적인 코드를 작성할 수 있는 점을 장점으로 원래의 **[R](https://www.r-project.org/)** 문법을 빠르게 대체하고 있다. **[본 블로그](https://blog.zarathu.com/posts/2019-01-03-rdatamanagement/)**에 정리 내용이 있다.  
  

3. **[data.table](https://github.com/Rdatatable/data.table/wiki)** 패키지는 빠른 실행속도를 장점으로 **[tidyverse](https://www.tidyverse.org/)** 의 득세 속에서 살아남았으며, 역시  **[과거 홈페이지](https://jinseob2kim.github.io/radv1.html)**^[https://jinseob2kim.github.io/radv1.html]에 정리한 바 있다. 


본 강의는 이중 첫 번째에 해당하며 2주차에 **[tidyverse](https://www.tidyverse.org/)** 를 다룰 것이다. **[data.table](https://github.com/Rdatatable/data.table/wiki)** 은 이번 교육에는 포함시키지 않았는데, R에 익숙해지면서 느린 속도가 점점 거슬린다면 **[data.table](https://github.com/Rdatatable/data.table/wiki)** 을 시작할 때이다.


실습은 **[RStudio cloud](https://rstudio.cloud)** 로 진행할 것이며, 아래 단계를 따라 실습환경을 구축하고 데이터를 다운받자.


> 1. https://rstudio.cloud 회원 가입

> 2. https://rstudio.cloud/spaces/53975/join?access_code=kuFNlbt%2FbSj6DH%2FuppMdXzvU4e1EPrQNgNsFAQBf 들어가서 __*"Join Space"*__ 클릭

> 3. 위쪽 __*"Projects"*__ 클릭 후, __*"New Project"*__ 를 눌러 __*"New Project from Git Repo"*__ 를 선택 후, Repo 주소 **https://github.com/jinseob2kim/lecture-snuhlab** 입력.


```{r, fig.cap="Project 생성", echo=F}
include_graphics("https://raw.githubusercontent.com/jinseob2kim/lecture-snuhlab/master/rstudiocloud2.png")

```


개인 PC에서 실습을 원한다면 http://www.r-project.org 와 https://rstudio.com/products/rstudio/download/#download 에서 **[R](https://www.r-project.org/)**과 **[RStudio](https://rstudio.com/)** 를 설치하자.


## 전체 강의 일정

|회차| 일시  | 주제  |
|---|---|---|
|**1**| **3월 18일(수) 11-13시**  | **R 데이터 매니지먼트 [기초](https://jinseob2kim.github.io/rbasic.html)**  |
|2|  4월 2일(목) 11-13시 |  R 데이터 매니지먼트 최근: [tidyverse](https://blog.zarathu.com/posts/2019-01-03-rdatamanagement/) |
|3|  4월 16일(목) 11-13시 | R 데이터 시각화: [ggplot2](https://evamaerey.github.io/ggplot_flipbook/ggplot_flipbook_xaringan.html)  |
|4|  4월 28일(목) 11-13시 | [의학연구에서의 기술통계](https://blog.zarathu.com/posts/2018-11-24-basic-biostatistics/)  |
|5|  5월 14일(목) 11-13시 | 회귀분석, 생존분석  |
|6|  5월 29일(목) 11-13시 | R로 논문쓰기: [rmarkdown](https://blog.zarathu.com/posts/2019-01-03-rmarkdown/) |


## *R* 기초연산 : 벡터(vector) 

*R* 의 기본 연산단위는 벡터이며, `x <- c(1, 2, 3)` 은 1,2,3 으로 이루어진 길이 3인 벡터를 `x` 에 저장한다. 대입연산자는 `=` 와 `<-` 둘 다 가능하지만 함수의 인자로도 쓰이는 `=` 와 구별하기 위해 `<-` 를 권장한다. 자주 쓰는 연산을 실습하자.

```{r}
x <- c(1, 2, 3, 4, 5, 6)            ## vector of variable
y <- c(7, 8, 9, 10, 11, 12)
x + y              
x * y
sqrt(x)
sum(x)
diff(x) 
mean(x)
sd(x)
max(x)
max(x, y)
length(x)
```

벡터에서 특정 항목을 골라내려면 그것의 **위치** 혹은 **조건문**을 이용한다. 

```{r}
x[2]                               ## 2 번째
x[-2]                              ## 2 번째만 빼고
x[1:3]                             ## 1-3 번째
x[c(1, 2, 3)]                      ## 동일 
x[c(1, 3, 4, 5, 6)]                ## 1, 3, 4, 5, 6  번째
x >= 4                             ## 각 항목이 4 이상인지 TRUE/FALSE
sum(x >= 4)                        ## TRUE 1, FALSE 0 인식 
x[x >= 4]                          ## TRUE 인 것들만, 즉 4 이상인 것들         
sum(x[x >= 4])                     ## 4 이상인 것들만 더하기. 
x %in% c(1, 3, 5)                  ## 1, 3, 5 중 하나에 속하는지 TRUE/FALSE
x[x %in% c(1, 3, 5)]               
```


### 벡터만들기

`seq` 로 일정 간격인, `rep` 로 항목들이 반복되는 벡터를 만들 수 있다. 

```{r}
v1 <- seq(-5, 5, by = .2); v1             ## Sequence

v2 <- rep(1, 3); v2                       ## Repeat
v3 <- rep(c(1, 2, 3), 2); v3              ## Repeat for vector
v4 <- rep(c(1, 2, 3), each = 2); v4       ## Repeat for vector : each
```


### `for`, `if/else`, `ifelse` 문 

`for` loop 는 같은 작업을 반복할 때 이용하며 `while` 도 비슷한 의미이다. 예시를 통해 배워보자.

```{r}
for (i in 1:3){
  print(i)
}

i <- 0
for (j in c(1, 2, 4, 5, 6)){
  i <- i + j
}
i
```

`if` 와 `else` 는 조건문을 다룬다. **`else` 나 `else if` 문은 선행 조건문의 마지막과 같은 줄**이어야 함을 기억하자.

```{r}
x <- 5
if (x >= 3 ){
  x <- x + 3
}
x

x <- 5
if (x >= 10){
  print("High")
} else if (x >= 5){
  print("Medium")
} else {
  print("Low")
}                                          ## else if, else 주의: 반드시 } 와 같은 줄에 위치하도록.
```

`ifelse` 는 **벡터화**된 `if/else` 문으로 벡터의 각 항목마다 조건문을 적용하는데, 엑셀의 `if` 문과 비슷하다. 

```{r}
x <- 1:6
y <- ifelse(x >= 4, "Yes", "No")           ## ifelse (조건,참일때,거짓일때)
y
```


### 함수 만들기 

막 **R**을 배우는 단계에서는 함수를 만들어 쓸 일이 거의 없겠지만, 결측치 포함된 데이터에서 평균이나 분산을 구할 때 귀찮을 수 있다. **R**은 결측치가 하나라도 포함되면 평균값, 분산값으로 `NA`를 출력하기 때문이다. 이를 해결하기 위해서라도 아래처럼 기초 함수 만드는 법은 알고 있는 것이 좋다. 


```{r}
x <- c(1:10, 12, 13, NA, NA, 15, 17)      ## 결측치가 포함되어 있다면..
mean(x)                                           
mean0 <- function(x){
  mean(x, na.rm = T)
}                                         ## mean함수의 na.rm 옵션을 TRUE로 바꿈. default는 F

mean0 <- function(x){mean(x, na.rm = T)}  ## 한줄에 쓸 수도 있다. 
mean0(x)
```

둘 이상의 변수를 포함한 함수도 다음과 같이 만들 수 있다.

```{r}
twomean <- function(x1, x2){
  a <- (x1 + x2)/2
  a
}
twomean(4, 6)
```


### Apply 문 : `apply`, `sapply`, `lapply`

벡터를 다루는 연산을 잘 활용하면, 벡터의 각 항목에 대해 `for` loop 을 쓰는 것보다 간편하게 코드를 작성할 수 있다. 행렬에서 행마다 평균을 구하는 예를 살펴보자.

```{r}
mat <- matrix(1:20, nrow = 4, byrow = T)   ## 4행 5열, byrow = T : 행부터 채운다. 
mat
```

모든 행에 대해 `for` loop 을 이용, 평균을 구하여 저장하는 코드는 아래와 같다.

```{r}
out <- NULL                                ## 빈 벡터, 여기에 하나씩 붙여넣는다.
for (i in 1:nrow(mat)){
  out <- c(out, mean(mat[i, ]))
}
out
```

처음에 빈 벡터를 만들고 여기에 결과를 붙여가는 모습이 번거로워 보인다. `sapply` 또는 `lapply` 를 사용하면 행 또는 열 단위 연산을 간단히 수행할 수 있다.

```{r}
sapply(1:nrow(mat), function(x){mean(mat[x, ])})             ## Return vector
lapply(1:nrow(mat), function(x){mean(mat[x, ])})             ## Return list type
unlist(lapply(1:nrow(mat), function(x){mean(mat[x, ])}))     ## Same to sapply
```

처음에 빈 벡터를 만들고, 이어붙이는 과정이 생략되어 간단한 코드가 되었다. **list** 는 벡터보다 더 상위의 개념으로, 본 강의에서는 `unlist` 를 취하면 벡터나 행렬을 얻게 된다는 정도만 언급하고 넘어가겠다. 사실 행렬의 행/열 단위 연산은 `apply` 혹은 `row***`, `col***` 시리즈의 함수가 따로 있어, 더 간단히 이용할 수 있다.

```{r}
apply(mat, 1, mean)                                          ## 1: 행
rowMeans(mat)                                                ## 동일
rowSums(mat)                                                 ## 행별로 합

apply(mat, 2, mean)                                          ## 2: 열
colMeans(mat)                                                ## 열별로 합


```

멀티코어 병렬연산으로 `apply` 를 빠르게 수행할 수도 있는데 본 강의에서는 생략한다. 궁금하신 분은 [과거 정리 내용](https://jinseob2kim.github.io/rbasic.html#apply_%EB%AC%B8_:_apply,_sapply,_lapply) 을 참고하기 바란다. 


## 데이터 불러와서 작업하기

이제부터는 실제 데이터를 읽어서 그 데이터를 매니징 하는 방법을 배워보도록 하겠다. 

### 데이터 불러오기, 저장하기

데이터를 불러오기 전에 미리 디렉토리를 지정하면 그 다음부터는 편하게 읽고 쓸 수 있다.

```{r, eval=T}
getwd()                                                     ## 현재 디렉토리 
setwd("data")                                               ## 디렉토리 설정
## 동일
setwd("/home/js/Homepage/blog/_posts/2020-02-16-rdatamanagement-basic/data")
getwd()
```


폴더 구분을  **"/"** 로 해야 한다는 점을 명심하자. **R** 은 유닉스 기반이기 때문이다. 이제 실습 데이터를 읽어볼텐데, 가급적이면 데이터 포맷은 `csv`로 만드는 것을 추천한다. 콤마로 분리된 가장 간단한 형태로, 용량도 작고 어떤 소프트웨어 에서도 읽을 수 있기 때문이다. 물론 Excel, SPSS, SAS 파일도 읽을 수 있는데, 변수명이나 값에 한글이 있으면 encoding 에러가 생길 수 있으므로 미리 처리하자. 


```{r, eval=F}
ex <- read.csv("example_g1e.csv")
head(ex)
```

```{r, echo=F,  eval=T}
ex <- read.csv("https://raw.githubusercontent.com/jinseob2kim/lecture-snuhlab/master/data/example_g1e.csv")
paged_table(head(ex))
```

Excel 파일은 **[readxl](https://readxl.tidyverse.org/)**, SAS나 SPSS는 **[haven](https://haven.tidyverse.org/)** 패키지를 이용한다.

```{r, eval=F}
library(readxl)                                            ## Package for xlsx
ex <- read_excel("example_g1e.xlsx", sheet = 1)            ## 1st sheet

library(haven)                                             ## Package for SAS/SPSS/STATA   
ex.sas <- read_sas("example_g1e.sas7bdat")                 ## SAS
ex.spss <- read_sav("example_g1e.sav")                     ## SPSS
```


파일 저장은 `write.csv` 를 이용하며, 맨 왼쪽에 나타나는 행 넘버링을 빼려면 `row.names = F` 옵션을 추가한다. 

```{r, eval=F}
write.csv(ex, "example_g1e_ex.csv", row.names = F)
```

**[haven](https://haven.tidyverse.org/)** 패키지에서 `write_sas` 나 `write_sav` 도 가능하다. 

```{r, eval=F}
write_sas(ex.sas, "example_g1e_ex.sas7bdat")
write_sav(ex.spss, "example_g1e_ex.sav")
```


## 마치며 

아래의 [Base R Cheat Sheet](https://rstudio.com/wp-content/uploads/2016/10/r-cheat-sheet-3.pdf) 에서 확인할 수 있다. 

<embed src="https://drive.google.com/viewerng/
viewer?embedded=true&url=https://rstudio.com/wp-content/uploads/2016/10/r-cheat-sheet-3.pdf" width="100%" height="600">



